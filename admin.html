<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omkar Taşımacılık - Yönetim Paneli</title>
    <link rel="stylesheet" href="omkar.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: var(--light-bg); padding-top: 110px; }
    </style>
</head>
<body>

<header>
    <div class="container">
        <div class="logo">
            <h1>Omkar<span>Admin</span></h1>
        </div>
        <nav>
            <ul>
                <li><a href="/">Siteye Dön</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="admin-container">

    <div id="loginSection" class="login-box">
        <h2 class="section-title" style="font-size:1.8rem;margin-bottom:25px;">Giriş Yap</h2>
        <form id="loginForm">
            <div class="form-group">
                <input type="text" id="username" placeholder="Kullanıcı Adı" required>
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Şifre" required>
            </div>
            <button type="submit" class="btn btn-submit">Giriş</button>
            <div id="loginFeedback" class="form-feedback"></div>
        </form>
    </div>

    <div id="dashboardSection" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:10px;">
            <h2 class="section-title" style="font-size:1.8rem;margin-bottom:0;">Gelen Mesajlar</h2>
            <button onclick="loadMessages()" class="btn" style="padding:10px 20px;font-size:0.85rem;">Yenile</button>
        </div>
        <div id="messagesContainer">
            <p>Mesajlar yükleniyor...</p>
        </div>
    </div>

</div>

<script>
const ADMIN_TOKEN = 'omkar-admin-2026';

document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('loginForm');

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const feedback = document.getElementById('loginFeedback');

        try {
            const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const result = await response.json();

            if (result.success) {
                feedback.style.color = 'green';
                feedback.textContent = 'Giriş Başarılı!';
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                loadMessages();
            } else {
                feedback.style.color = 'red';
                feedback.textContent = result.message || 'Hatalı giriş.';
            }
        } catch (error) {
            feedback.style.color = 'red';
            feedback.textContent = 'Bağlantı hatası oluştu.';
        }
    });
});

async function loadMessages() {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '<p>Yükleniyor...</p>';
    try {
        const response = await fetch('/api/admin/messages', {
            headers: { 'x-admin-auth': ADMIN_TOKEN }
        });
        const messages = await response.json();

        if (!Array.isArray(messages) || messages.length === 0) {
            container.innerHTML = '<p style="color:#666;text-align:center;padding:30px;">Henüz mesaj yok.</p>';
        } else {
            container.innerHTML = messages.map(msg => `
                <div class="message-card" id="msg-${msg.id}">
                    <div class="message-header">
                        <span>${escapeHtml(msg.name)} &lt;${escapeHtml(msg.email)}&gt;</span>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <span style="color:#888;font-size:0.85rem;">${escapeHtml(msg.date)}</span>
                            <button class="delete-btn" onclick="deleteMessage(${msg.id})">Sil</button>
                        </div>
                    </div>
                    <div class="message-body">
                        <p style="margin-bottom:6px;"><strong>Tel:</strong> <a href="tel:${escapeHtml(msg.phone)}">${escapeHtml(msg.phone)}</a></p>
                        <p style="white-space:pre-wrap;">${escapeHtml(msg.message)}</p>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        container.innerHTML = '<p style="color:red;">Mesajlar yüklenemedi. Sunucu bağlantısını kontrol edin.</p>';
    }
}

async function deleteMessage(id) {
    if (!confirm('Bu mesajı silmek istediğinize emin misiniz?')) return;
    try {
        const res = await fetch('/api/admin/messages/' + id, {
            method: 'DELETE',
            headers: { 'x-admin-auth': ADMIN_TOKEN }
        });
        const result = await res.json();
        if (result.success) {
            document.getElementById('msg-' + id).remove();
        }
    } catch(e) {
        alert('Silme işlemi başarısız.');
    }
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}
</script>
</body>
</html>
